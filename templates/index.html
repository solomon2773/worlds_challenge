<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coding Challenge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tab-content {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-height: 500px;
            padding: 30px;
        }

        .main-panel {
            width: 100%;
        }

        .query-controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .query-controls .btn {
            flex: 1;
            min-width: 150px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .results h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        .result-section {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .result-section h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 2px solid #f8f9fa;
            padding-bottom: 10px;
        }

        .query-description {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            color: #495057;
            font-style: italic;
        }

        .data-structure {
            margin-bottom: 20px;
        }

        .data-structure pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.9rem;
            border: 1px solid #e9ecef;
            max-height: 300px;
        }

        .sample-data {
            margin-top: 15px;
        }

        .result-item {
            padding: 10px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }

        .result-item strong {
            color: #495057;
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .device-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .device-name {
            font-weight: 600;
            color: #333;
        }

        .device-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-enabled {
            background: #d4edda;
            color: #155724;
        }

        .status-disabled {
            background: #f8d7da;
            color: #721c24;
        }

        .device-info {
            margin-bottom: 15px;
        }

        .device-info p {
            margin: 5px 0;
            color: #666;
            font-size: 0.9rem;
        }

        .video-container {
            width: 100%;
            height: 200px;
            background: #f8f9fa;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            border: 2px dashed #dee2e6;
        }

        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            padding: 12px 24px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #495057;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .device-selector {
            margin-bottom: 20px;
        }

        .device-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 1rem;
            background: white;
        }

        .device-selector select:focus {
            outline: none;
            border-color: #667eea;
        }

        .realtime-data {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .realtime-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .realtime-item .timestamp {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .realtime-item .data {
            font-family: monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
        }

        .detection-summary {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .detection-summary h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.1rem;
        }

        .detection-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-section {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
        }

        .info-section h5 {
            margin: 0 0 8px 0;
            color: #495057;
            font-size: 0.9rem;
        }

        .info-section p {
            margin: 4px 0;
            font-size: 0.85rem;
            color: #666;
        }

        .video-thumbnail {
            max-width: 200px;
            max-height: 150px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .video-display-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .video-container-main {
            position: relative;
            width: 512px;
            height: 288px;
            margin: 0 auto;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        .video-thumbnail-main {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .bounding-box {
            position: absolute;
            border: 2px solid #ff0000;
            background: rgba(255, 0, 0, 0.1);
            pointer-events: none;
        }

        .bounding-box-label {
            position: absolute;
            top: -20px;
            left: 0;
            background: #ff0000;
            color: white;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 3px;
            white-space: nowrap;
        }

        .no-video-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-size: 16px;
        }

        .detection-details {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .detection-details h6 {
            margin: 0 0 8px 0;
            color: #495057;
            font-size: 0.9rem;
        }

        .coordinates {
            font-family: monospace;
            font-size: 0.8rem;
            background: white;
            padding: 5px;
            border-radius: 3px;
            margin: 5px 0;
        }

        .connection-status {
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 600;
            margin-bottom: 15px;
            display: inline-block;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-connecting {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Coding Challenge</h1>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('data-explorer')">Data Explorer</button>
            <button class="tab" onclick="switchTab('mutations')">Mutations</button>
            <button class="tab" onclick="switchTab('realtime-monitor')">Real-time Monitor</button>
            <button class="tab" onclick="switchTab('database')">Database Analytics</button>
        </div>

        <div id="data-explorer" class="tab-content active">
            <div class="main-panel">
                <h2>GraphQL Querie Examples</h2>
                <p>Explore available data through example queries for devices, tracks, and detections.</p>
                <p>Requirement 1 , actual example code is named example_queries.py. Goal 1</p>
                
                <div class="query-controls">
                    <button class="btn" onclick="runAllQueries()" id="runAllBtn">
                        Run All Example Queries
                    </button>
                  
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p id="loadingText">Running queries...</p>
                </div>

                <div id="queryResults" class="results" style="display: none;">
                    <h3>Query Results</h3>
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>


        <div id="mutations" class="tab-content">
            <div class="main-panel">
                <h2>GraphQL Mutations</h2>
                <p>Execute GraphQL mutations to create events based on detection criteria.</p>
                <p>Requirement 3, actual example code is named example_mutation.py. Goal 4</p>
                
                <div class="query-controls">
                    <button class="btn" onclick="runAllMutations()" id="runMutationsBtn">
                        Run All Example Mutations
                    </button>
                
                </div>

                <div class="loading" id="mutationLoading" style="display: none;">
                    <div class="spinner"></div>
                    <p id="mutationLoadingText">Running mutations...</p>
                </div>

                <div id="mutationResults" class="results" style="display: none;">
                    <h3>Mutation Results</h3>
                    <div id="mutationContent"></div>
                </div>
            </div>
        </div>
        
        <div id="realtime-monitor" class="tab-content">
            <div class="main-panel">
                <h2>Real-time Device Monitor</h2>
                <p>Select a device to subscribe to detection data using GraphQL WebSocket subscriptions.</p>
                <p>Requirement 2, actual example code is named example_subscription.py. Goal 2,3</p>
                <div class="device-selector">
                    <label for="deviceSelect">Select Device:</label>
                    <select id="deviceSelect" onchange="onDeviceChange()">
                        <option value="">Loading devices...</option>
                    </select>
                </div>

                <div id="connectionStatus" class="connection-status status-disconnected">
                    Disconnected
                </div>

                <div class="video-display-section" id="videoDisplaySection" style="display: none;">
                    <h3>Detection View</h3>
                    <div class="video-container-main" id="videoContainer">
                        <div class="no-video-message">No video thumbnail available</div>
                    </div>
                </div>

                <div class="realtime-data" id="realtimeData" style="display: none;">
                    <h3>Detection Data Log</h3>
                    <div id="realtimeContent"></div>
                </div>
            </div>
        </div>

        <div id="database" class="tab-content">
            <div class="main-panel">
                <h2>Database Analytics</h2>
                <p>Analyze stored detection data from real-time devices. View statistics, query historical data, and perform data aggregation.</p>
                <p>Requirement 4,5,6</p>
                <div class="query-controls">
                    <button class="btn" onclick="loadDatabaseStats()" id="loadStatsBtn">
                        Load Database Statistics
                    </button>
                    <button class="btn" onclick="loadDetectionStats()" id="loadDetectionStatsBtn">
                        Load Detection Statistics
                    </button>
                    <button class="btn" onclick="loadRecentDetections()" id="loadRecentBtn">
                        Load Recent Detections
                    </button>
                    <button class="btn" onclick="loadAllTags()" id="loadTagsBtn">
                        List All Tags
                    </button>
                    <button class="btn" onclick="loadLongestTracksPerTag()" id="loadLongestTracksBtn">
                        Longest Track per Tag
                    </button>
                </div>

                <div class="loading" id="dbLoading" style="display: none;">
                    <div class="spinner"></div>
                    <p id="dbLoadingText">Loading database data...</p>
                </div>

                <div id="dbResults" class="results" style="display: none;">
                    <h3>Database Analytics Results</h3>
                    <div id="dbContent"></div>
                </div>
            </div>
        </div>
        
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script>
        async function runAllQueries() {
            const runBtn = document.getElementById('runAllBtn');
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            const results = document.getElementById('queryResults');
            
            runBtn.disabled = true;
            loading.style.display = 'block';
            loadingText.textContent = 'Running all example queries...';
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/run-queries', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'started') {
                    pollQueryResults();
                }
            } catch (error) {
                showError('Failed to start queries: ' + error.message);
                runBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

     
        async function pollQueryResults(filterType = null) {
            try {
                const response = await fetch('/api/query-results');
                const results = await response.json();
                
                if (results.error) {
                    showError('Query execution failed: ' + results.error);
                    resetButtons();
                    document.getElementById('loading').style.display = 'none';
                    return;
                }
                
                if (Object.keys(results).length > 0) {
                    displayResults(results, filterType);
                    resetButtons();
                    document.getElementById('loading').style.display = 'none';
                } else {
                    // Continue polling
                    setTimeout(() => pollQueryResults(filterType), 1000);
                }
            } catch (error) {
                showError('Failed to fetch results: ' + error.message);
                resetButtons();
                document.getElementById('loading').style.display = 'none';
            }
        }

        function resetButtons() {
            document.getElementById('runAllBtn').disabled = false;
        }

        function displayResults(results, filterType = null) {
            const content = document.getElementById('resultsContent');
            const resultsDiv = document.getElementById('queryResults');
            
            let html = '';
            
            // Filter results if specific query type requested
            const filteredResults = filterType ? 
                { [filterType]: results[filterType] } : 
                results;
            
            for (const [key, data] of Object.entries(filteredResults)) {
                if (data && Array.isArray(data)) {
                    html += `
                        <div class="result-section">
                            <h4>${getQueryTitle(key)} (${data.length} items)</h4>
                            <div class="query-description">
                                ${getQueryDescription(key)}
                            </div>
                            <div class="data-structure">
                                <strong>Data Structure:</strong>
                                <pre>${JSON.stringify(data[0] || {}, null, 2)}</pre>
                            </div>
                            <div class="sample-data">
                                <strong>Sample Data (first ${Math.min(3, data.length)} items):</strong>
                                ${data.slice(0, 3).map((item, index) => `
                                    <div class="result-item">
                                        <strong>Item ${index + 1}:</strong>
                                        ${formatResultItem(item)}
                                    </div>
                                `).join('')}
                                ${data.length > 3 ? `<p><em>... and ${data.length - 3} more items</em></p>` : ''}
                            </div>
                        </div>
                    `;
                }
            }
            
            content.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        function getQueryTitle(key) {
            const titles = {
                'devices': 'Devices Query',
                'tracks': 'Tracks Query', 
                'detections_time': 'Detections by Time Range',
                'detections_person': 'Detections by Tag (Person)'
            };
            return titles[key] || key.charAt(0).toUpperCase() + key.slice(1);
        }

        function getQueryDescription(key) {
            const descriptions = {
                'devices': 'Fetches device information including ID, UUID, name, status, address, and site details.',
                'tracks': 'Fetches track data with video information, detections, and associated device/site data.',
                'detections_time': 'Fetches detections within a specific time range with track and device information.',
                'detections_person': 'Fetches detections filtered by tag (person) with position and confidence data.'
            };
            return descriptions[key] || 'Query results data';
        }

        function formatResultItem(item) {
            if (item.id) {
                return `<strong>ID:</strong> ${item.id} | <strong>Name:</strong> ${item.name || 'N/A'}`;
            }
            return JSON.stringify(item, null, 2);
        }


        function showError(message) {
            const content = document.getElementById('resultsContent');
            content.innerHTML = `<div class="error">${message}</div>`;
            document.getElementById('queryResults').style.display = 'block';
        }

        // Global variables for Socket.IO connection
        let socket = null;
        let currentDeviceId = null;

        // Tab switching functionality
        function switchTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabId).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Handle tab-specific logic
            if (tabId === 'realtime-monitor') {
                // Load devices and initialize Socket.IO when switching to real-time monitor
                loadDevices();
                if (!socket) {
                    initializeSocket();
                }
            } else if (tabId === 'data-explorer') {
                // Disconnect from current device when switching to data explorer
                if (currentDeviceId && socket) {
                    socket.emit('leave_device', { device_id: currentDeviceId });
                    currentDeviceId = null;
                    updateConnectionStatus('disconnected');
                    document.getElementById('realtimeData').style.display = 'none';
                    clearDetectionData();
                    clearVideoDisplay();
                }
            } else if (tabId === 'mutations') {
                // No special handling needed for mutations tab
            } else if (tabId === 'database') {
                // Load database stats when switching to database tab
                loadDatabaseStats();
            }
        }

        // Load devices for dropdown
        async function loadDevices() {
            try {
                const response = await fetch('/api/devices');
                const data = await response.json();
                
                const select = document.getElementById('deviceSelect');
                select.innerHTML = '<option value="pulse">Select a device...</option>';
                
                if (data.devices && data.devices.length > 0) {
                    data.devices.forEach(device => {
                        if (device.enabled){
                            const option = document.createElement('option');
                            option.value = device.uuid;
                            option.textContent = `${device.name || 'Unnamed'} (ID: ${device.id}) - ${device.enabled ? 'Enabled' : 'Disabled'}`;
                            select.appendChild(option);
                        }
                        
                    });
                } else {
                    select.innerHTML = '<option value="">No devices available</option>';
                }
            } catch (error) {
                console.error('Failed to load devices:', error);
                document.getElementById('deviceSelect').innerHTML = '<option value="">Error loading devices</option>';
            }
        }

        // Handle device selection change
        function onDeviceChange() {
            const select = document.getElementById('deviceSelect');
            const deviceId = select.value;
            
            // Leave current device room
            if (currentDeviceId && socket) {
                socket.emit('leave_device', { device_id: currentDeviceId });
            }
            
            // Clear previous detection data, currently i want to keep all the data in the log panel
            //clearDetectionData();
            
            if (deviceId && deviceId !== 'pulse') {
                currentDeviceId = deviceId;
                connectToDevice(deviceId);
            } else {
                // Disconnect when "Select a device..." is selected
                currentDeviceId = null;
                updateConnectionStatus('disconnected');
                //document.getElementById('realtimeData').style.display = 'none';
            }
        }

        // Connect to device for real-time data
        function connectToDevice(deviceId) {
            if (!socket) {
                initializeSocket();
                // Wait for socket to be ready before joining device
                socket.on('connect', function() {
                    updateConnectionStatus('connecting');
                    socket.emit('join_device', { device_id: deviceId });
                    document.getElementById('realtimeData').style.display = 'block';
                });
            } else {
                updateConnectionStatus('connecting');
                socket.emit('join_device', { device_id: deviceId });
                document.getElementById('realtimeData').style.display = 'block';
            }
        }

        // Initialize Socket.IO connection
        function initializeSocket() {
            if (socket) {
                return; // Already initialized
            }
            
            socket = io();
            
            socket.on('connect', function() {
                console.log('Socket.IO connected');
                updateConnectionStatus('connected');
            });
            
            socket.on('disconnect', function() {
                console.log('Socket.IO disconnected');
                updateConnectionStatus('disconnected');
            });
            
            socket.on('detection_data', function(data) {
                displayRealtimeData(data);
            });
            
            socket.on('connection_status', function(data) {
                if (data.status === 'connected') {
                    updateConnectionStatus('connected');
                }
            });
            
            socket.on('connect_error', function(error) {
                console.error('Socket.IO connection error:', error);
                updateConnectionStatus('disconnected');
            });
            
            socket.on('error', function(error) {
                console.error('Socket.IO error:', error);
                updateConnectionStatus('disconnected');
            });
        }

        // Update connection status display
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            const videoSection = document.getElementById('videoDisplaySection');
            statusEl.className = `connection-status status-${status}`;
            
            switch(status) {
                case 'connected':
                    statusEl.textContent = 'Connected';
                    videoSection.style.display = 'block';
                    break;
                case 'connecting':
                    statusEl.textContent = 'Connecting...';
                    videoSection.style.display = 'none';
                    break;
                case 'disconnected':
                    statusEl.textContent = 'Disconnected';
                    videoSection.style.display = 'none';
                    clearVideoDisplay();
                    break;
            }
        }

        // Clear detection data
        function clearDetectionData() {
            const content = document.getElementById('realtimeContent');
            content.innerHTML = '';
        }

        // Clear video display
        function clearVideoDisplay() {
            const videoContainer = document.getElementById('videoContainer');
            videoContainer.innerHTML = '<div class="no-video-message">No video available</div>';
        }

        // Update video display with bounding boxes
        function updateVideoDisplay(data) {
            const videoContainer = document.getElementById('videoContainer');
            const track = data.track || {};
            const video = track.video || {};
            const detections = track.detections || [];
            
            if (!video.thumbnailUrl) {
                videoContainer.innerHTML = '<div class="no-video-message">No video available</div>';
                return;
            }

            // Create video element
            let videoElement = videoContainer.querySelector('.video-thumbnail-main');
            if (!videoElement) {
                videoContainer.innerHTML = '';
                videoElement = document.createElement('img');
                videoElement.className = 'video-thumbnail-main';
                videoElement.src = video.thumbnailUrl;
                videoElement.alt = 'Video Thumbnail';
                videoContainer.appendChild(videoElement);
            } else {
                videoElement.src = video.thumbnailUrl;
            }

            // Clear existing bounding boxes
            const existingBoxes = videoContainer.querySelectorAll('.bounding-box');
            existingBoxes.forEach(box => box.remove());

            // Add bounding boxes for each detection
            detections.forEach((detection, index) => {
                if (detection.polygon && detection.polygon.coordinates) {
                    const bbox = createBoundingBox(detection.polygon.coordinates, detection.tag || 'unknown', index);
                    if (bbox) {
                        videoContainer.appendChild(bbox);
                    }
                }
            });
        }

        // Create bounding box element
        function createBoundingBox(coordinates, tag, index) {
            if (!coordinates || coordinates.length === 0) return null;

            // Get the first ring of coordinates (polygon format)
            const ring = coordinates[0];
            if (!ring || ring.length < 4) return null;

            // Find min/max coordinates
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            ring.forEach(coord => {
                const [x, y] = coord;
                minX = Math.min(minX, x);
                minY = Math.min(minY, y);
                maxX = Math.max(maxX, x);
                maxY = Math.max(maxY, y);
            });

            // Scale from 1920x1080 to 512x288
            const scaleX = 512 / 1920;
            const scaleY = 288 / 1080;

            const scaledX = minX * scaleX;
            const scaledY = minY * scaleY;
            const scaledWidth = (maxX - minX) * scaleX;
            const scaledHeight = (maxY - minY) * scaleY;

            // Create bounding box element
            const bbox = document.createElement('div');
            bbox.className = 'bounding-box';
            bbox.style.left = scaledX + 'px';
            bbox.style.top = scaledY + 'px';
            bbox.style.width = scaledWidth + 'px';
            bbox.style.height = scaledHeight + 'px';

            // Create label
            const label = document.createElement('div');
            label.className = 'bounding-box-label';
            label.textContent = tag;
            bbox.appendChild(label);

            return bbox;
        }

        // Display real-time data
        function displayRealtimeData(data) {
            const content = document.getElementById('realtimeContent');
            const timestamp = new Date().toLocaleTimeString();
            
            // Update video display with bounding boxes
            updateVideoDisplay(data);
            
            const item = document.createElement('div');
            item.className = 'detection-summary';
            
            // Extract data from the detection activity
            const track = data.track || {};
            const video = track.video || {};
            const detections = track.detections || [];
            const position = data.position || {};
            
            let videoInfo = '';
            if (video.thumbnailUrl) {
                videoInfo = `
                    <div class="info-section">
                        <h5>Video Information</h5>
                        <p><strong>Resolution:</strong> ${video.resolutionWidth || 'N/A'} x ${video.resolutionHeight || 'N/A'}</p>
                        <p><strong>Device:</strong> ${video.dataSource?.device?.name || 'N/A'}</p>
                    </div>
                `;
            }
            
            let detectionInfo = '';
            if (detections.length > 0) {
                detectionInfo = `
                    <div class="detection-details">
                        <h6>Detection Details (${detections.length} detection${detections.length > 1 ? 's' : ''})</h6>
                        ${detections.map((detection, index) => `
                            <div style="margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px;">
                                <p><strong>Detection ${index + 1}:</strong></p>
                                ${detection.frame ? `<p>Frame: ${detection.frame.number || 'N/A'}</p>` : ''}
                                ${detection.position ? `
                                    <p><strong>Position:</strong></p>
                                    <div class="coordinates">${JSON.stringify(detection.position.coordinates || [], null, 2)}</div>
                                ` : ''}
                                ${detection.polygon ? `
                                    <p><strong>Polygon:</strong></p>
                                    <div class="coordinates">${JSON.stringify(detection.polygon.coordinates || [], null, 2)}</div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            item.innerHTML = `
                <h4>Detection Activity - ${timestamp}</h4>
                <div class="detection-info">
                    <div class="info-section">
                        <h5>Track Information</h5>
                        <p><strong>Track ID:</strong> ${track.id || 'N/A'}</p>
                        <p><strong>Tag:</strong> ${track.tag || 'N/A'}</p>
                        <p><strong>Timestamp:</strong> ${data.timestamp || 'N/A'}</p>
                        <p><strong>Position:</strong> ${JSON.stringify(position.coordinates || [], null, 2)}</p>
                    </div>
                    ${videoInfo}
                </div>
                ${detectionInfo}
                <details style="margin-top: 10px;">
                    <summary style="cursor: pointer; color: #667eea; font-weight: 600;">Raw Data</summary>
                    <div class="data" style="margin-top: 10px;">${JSON.stringify(data, null, 2)}</div>
                </details>
            `;
            
            // Add to top of the list
            content.insertBefore(item, content.firstChild);
            
            // Keep only last 20 items (reduced due to larger content)
            while (content.children.length > 20) {
                content.removeChild(content.lastChild);
            }
        }

        // Mutation functions
        async function runAllMutations() {
            const runBtn = document.getElementById('runMutationsBtn');
            const loading = document.getElementById('mutationLoading');
            const loadingText = document.getElementById('mutationLoadingText');
            const results = document.getElementById('mutationResults');
            
            runBtn.disabled = true;
            loading.style.display = 'block';
            loadingText.textContent = 'Running all example mutations...';
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/run-mutations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'started') {
                    pollMutationResults();
                }
            } catch (error) {
                showMutationError('Failed to start mutations: ' + error.message);
                runBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        async function pollMutationResults() {
            try {
                const response = await fetch('/api/mutation-results');
                const results = await response.json();
                
                if (results.error) {
                    showMutationError('Mutation execution failed: ' + results.error);
                    resetMutationButtons();
                    document.getElementById('mutationLoading').style.display = 'none';
                    return;
                }
                
                if (Object.keys(results).length > 0) {
                    displayMutationResults(results);
                    resetMutationButtons();
                    document.getElementById('mutationLoading').style.display = 'none';
                } else {
                    // Continue polling
                    setTimeout(() => pollMutationResults(), 1000);
                }
            } catch (error) {
                showMutationError('Failed to fetch mutation results: ' + error.message);
                resetMutationButtons();
                document.getElementById('mutationLoading').style.display = 'none';
            }
        }

        function resetMutationButtons() {
            document.getElementById('runMutationsBtn').disabled = false;

        }

        function displayMutationResults(results) {
            const content = document.getElementById('mutationContent');
            const resultsDiv = document.getElementById('mutationResults');
            
            let html = '';
            
            for (const [key, data] of Object.entries(results)) {
                if (data) {
                    html += `
                        <div class="result-section">
                            <h4>${getMutationTitle(key)}</h4>
                            <div class="data-structure">
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </div>
                        </div>
                    `;
                }
            }
            
            content.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        function getMutationTitle(key) {
            const titles = {
                'event_producer': 'Event Producer Created',
                'detection_events': 'Detection Events Created',
                'high_confidence_event': 'High Confidence Event Created',
                'zone_violation_event': 'Zone Violation Event Created',
            };
            return titles[key] || key.charAt(0).toUpperCase() + key.slice(1);
        }

        function showMutationError(message) {
            const content = document.getElementById('mutationContent');
            content.innerHTML = `<div class="error">${message}</div>`;
            document.getElementById('mutationResults').style.display = 'block';
        }

        // Database analytics functions
        async function loadDatabaseStats() {
            showDbLoading('Loading database statistics...');
            
            try {
                const response = await fetch('/api/database/stats');
                const data = await response.json();
                
                if (data.error) {
                    showDbError('Failed to load database stats: ' + data.error);
                } else {
                    displayDbStats(data);
                }
            } catch (error) {
                showDbError('Failed to load database stats: ' + error.message);
            } finally {
                hideDbLoading();
            }
        }

        async function loadDetectionStats() {
            showDbLoading('Loading detection statistics...');
            
            try {
                const response = await fetch('/api/database/detection-stats?hours=24');
                const data = await response.json();
                
                if (data.error) {
                    showDbError('Failed to load detection stats: ' + data.error);
                } else {
                    displayDetectionStats(data);
                }
            } catch (error) {
                showDbError('Failed to load detection stats: ' + error.message);
            } finally {
                hideDbLoading();
            }
        }

        async function loadRecentDetections() {
            showDbLoading('Loading recent detections...');
            
            try {
                const response = await fetch('/api/database/recent-detections?limit=50');
                const data = await response.json();
                
                if (data.error) {
                    showDbError('Failed to load recent detections: ' + data.error);
                } else {
                    displayDetections(data, 'Recent Detections (Last 50)');
                }
            } catch (error) {
                showDbError('Failed to load recent detections: ' + error.message);
            } finally {
                hideDbLoading();
            }
        }

        async function loadAllTags() {
            showDbLoading('Loading all tags...');
            
            try {
                const response = await fetch('/api/database/tags');
                const data = await response.json();
                
                if (data.error) {
                    showDbError('Failed to load tags: ' + data.error);
                } else {
                    displayTags(data);
                }
            } catch (error) {
                showDbError('Failed to load tags: ' + error.message);
            } finally {
                hideDbLoading();
            }
        }

        async function loadLongestTracksPerTag() {
            showDbLoading('Loading longest tracks per tag...');
            
            try {
                const response = await fetch('/api/database/longest-tracks-per-tag');
                const data = await response.json();
                
                if (data.error) {
                    showDbError('Failed to load longest tracks: ' + data.error);
                } else {
                    displayLongestTracksPerTag(data);
                }
            } catch (error) {
                showDbError('Failed to load longest tracks: ' + error.message);
            } finally {
                hideDbLoading();
            }
        }

        function showDbLoading(message) {
            document.getElementById('dbLoadingText').textContent = message;
            document.getElementById('dbLoading').style.display = 'block';
        }

        function hideDbLoading() {
            document.getElementById('dbLoading').style.display = 'none';
        }

        function displayDbStats(stats) {
            const content = document.getElementById('dbContent');
            const resultsDiv = document.getElementById('dbResults');
            
            const html = `
                <div class="result-section">
                    <h4>Database Overview</h4>
                    <div class="data-structure">
                        <p><strong>Total Detections:</strong> ${stats.total_detections || 0}</p>
                        <p><strong>Total Tracks:</strong> ${stats.total_tracks || 0}</p>
                        <p><strong>Latest Detection:</strong> ${stats.latest_detection || 'N/A'}</p>
                        <p><strong>Oldest Detection:</strong> ${stats.oldest_detection || 'N/A'}</p>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        function displayDetectionStats(stats) {
            const content = document.getElementById('dbContent');
            const resultsDiv = document.getElementById('dbResults');
            
            let html = '<div class="result-section"><h4>Detection Statistics (Last 24 Hours)</h4>';
            
            if (Array.isArray(stats)) {
                // Multiple devices
                html += '<div class="data-structure">';
                stats.forEach(stat => {
                    html += `
                        <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            <p><strong>Device:</strong> ${stat.device_name || stat.device_id}</p>
                            <p><strong>Total Detections:</strong> ${stat.total_detections}</p>
                            <p><strong>Unique Tracks:</strong> ${stat.unique_tracks}</p>
                            <p><strong>Unique Tags:</strong> ${stat.unique_tags}</p>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                // Single device
                html += `
                    <div class="data-structure">
                        <p><strong>Device:</strong> ${stats.device_name || stats.device_id}</p>
                        <p><strong>Total Detections:</strong> ${stats.total_detections}</p>
                        <p><strong>Unique Tracks:</strong> ${stats.unique_tracks}</p>
                        <p><strong>Unique Tags:</strong> ${stats.unique_tags}</p>
                    </div>
                `;
            }
            
            html += '</div>';
            content.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        function displayDetections(detections, title) {
            const content = document.getElementById('dbContent');
            const resultsDiv = document.getElementById('dbResults');
            
            let html = `<div class="result-section"><h4>${title}</h4>`;
            html += `<p><strong>Count:</strong> ${detections.length} detections</p>`;
            
            if (detections.length > 0) {
                html += '<div class="data-structure">';
                detections.slice(0, 10).forEach((detection, index) => {
                    html += `
                        <div style="margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                            <p><strong>Detection ${index + 1}:</strong></p>
                            <p><strong>Device:</strong> ${detection.device_name || detection.device_id}</p>
                            <p><strong>Track:</strong> ${detection.track_id}</p>
                            <p><strong>Tag:</strong> ${detection.tag}</p>
                            <p><strong>Timestamp:</strong> ${detection.timestamp}</p>
                            <p><strong>Direction:</strong> ${detection.direction || 'N/A'}</p>
                        </div>
                    `;
                });
                
                if (detections.length > 10) {
                    html += `<p><em>... and ${detections.length - 10} more detections</em></p>`;
                }
                
                html += '</div>';
            } else {
                html += '<p>No detections found.</p>';
            }
            
            html += '</div>';
            content.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        function displayTags(tags) {
            const content = document.getElementById('dbContent');
            const resultsDiv = document.getElementById('dbResults');
            
            let html = '<div class="result-section"><h4>All Tags Analysis</h4>';
            html += `<p><strong>Total Unique Tags:</strong> ${tags.length}</p>`;
            
            if (tags.length > 0) {
                html += '<div class="data-structure">';
                html += '<table style="width: 100%; border-collapse: collapse; margin-top: 15px;">';
                html += '<thead><tr style="background: #f8f9fa;">';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Tag</th>';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Detection Count</th>';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Track Count</th>';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Device Count</th>';
                html += '</tr></thead><tbody>';
                
                tags.forEach(tag => {
                    html += '<tr>';
                    html += `<td style="padding: 10px; border: 1px solid #dee2e6;"><strong>${tag.tag}</strong></td>`;
                    html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${tag.detection_count}</td>`;
                    html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${tag.track_count}</td>`;
                    html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${tag.device_count}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                html += '</div>';
            } else {
                html += '<p>No tags found in the database.</p>';
            }
            
            html += '</div>';
            content.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        function displayLongestTracksPerTag(tracks) {
            const content = document.getElementById('dbContent');
            const resultsDiv = document.getElementById('dbResults');
            
            let html = '<div class="result-section"><h4>Longest Track per Tag</h4>';
            html += `<p><strong>Total Tags with Tracks:</strong> ${tracks.length}</p>`;
            
            if (tracks.length > 0) {
                html += '<div class="data-structure">';
                html += '<table style="width: 100%; border-collapse: collapse; margin-top: 15px;">';
                html += '<thead><tr style="background: #f8f9fa;">';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Tag</th>';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Track ID</th>';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Device</th>';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Detection Count</th>';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Duration (seconds)</th>';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">First Detection</th>';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Last Detection</th>';
                html += '</tr></thead><tbody>';
                
                tracks.forEach(track => {
                    const duration = track.duration_seconds ? Math.round(track.duration_seconds) : 'N/A';
                    const firstDetection = track.first_detection ? new Date(track.first_detection).toLocaleString() : 'N/A';
                    const lastDetection = track.last_detection ? new Date(track.last_detection).toLocaleString() : 'N/A';
                    
                    html += '<tr>';
                    html += `<td style="padding: 10px; border: 1px solid #dee2e6;"><strong>${track.tag}</strong></td>`;
                    html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${track.track_id}</td>`;
                    html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${track.device_name || track.device_id}</td>`;
                    html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${track.detection_count}</td>`;
                    html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${duration}</td>`;
                    html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${firstDetection}</td>`;
                    html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${lastDetection}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                html += '</div>';
            } else {
                html += '<p>No tracks found in the database.</p>';
            }
            
            html += '</div>';
            content.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        function showDbError(message) {
            const content = document.getElementById('dbContent');
            content.innerHTML = `<div class="error">${message}</div>`;
            document.getElementById('dbResults').style.display = 'block';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('GraphQL Data Explorer loaded');
        });
    </script>
</body>
</html>
